<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIGHTMARE WEB - L'Antre des √Çmes</title>
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        @keyframes flicker {
            0% { opacity: 1; text-shadow: none; }
            5% { opacity: 0.3; text-shadow: 0 0 15px #C9BEFF; }
            10% { opacity: 1; text-shadow: none; }
            15% { opacity: 0.2; text-shadow: 0 0 20px #C9BEFF; }
            20% { opacity: 1; text-shadow: none; }
            25% { opacity: 0.4; text-shadow: 0 0 10px #C9BEFF; }
            30% { opacity: 1; text-shadow: none; }
            100% { opacity: 1; text-shadow: none; }
        }

        @keyframes static {
            0% { transform: translate(0, 0); filter: brightness(1); }
            10% { transform: translate(-3px, 3px); filter: brightness(1.2); }
            20% { transform: translate(3px, -2px); filter: brightness(0.8); }
            30% { transform: translate(-2px, 1px); filter: brightness(1.1); }
            40% { transform: translate(2px, -1px); filter: brightness(0.9); }
            50% { transform: translate(0, 0); filter: brightness(1); }
            100% { transform: translate(0, 0); filter: brightness(1); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px #8B0000; }
            50% { box-shadow: 0 0 30px #FF4500; }
            100% { box-shadow: 0 0 10px #8B0000; }
        }

        body {
            background-color: #262626;
            color: #C9BEFF;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(201, 190, 255, 0.03) 0px,
                transparent 2px,
                rgba(201, 190, 255, 0.03) 4px
            );
            pointer-events: none;
            z-index: 1;
            animation: static 12s infinite;
        }

        .navbar {
            background-color: #1a1a1a;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #C9BEFF;
            position: relative;
            z-index: 10;
            flex-wrap: wrap;
        }

        .logo {
            color: #C9BEFF;
            font-size: 1.5rem;
            text-decoration: none;
            letter-spacing: 5px;
            animation: flicker 5s infinite;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #C9BEFF;
            text-decoration: none;
            font-size: 0.9rem;
            letter-spacing: 2px;
            opacity: 0.7;
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover {
            opacity: 1;
            text-shadow: 0 0 10px #C9BEFF;
        }

        .nav-links a.active {
            opacity: 1;
            border-bottom: 1px solid #C9BEFF;
        }

        .user-info {
            color: #C9BEFF;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: none;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            padding: 0.3rem 0.8rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .logout-btn:hover {
            background-color: #C9BEFF;
            color: #262626;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 5;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h1 {
            font-size: 2rem;
            letter-spacing: 5px;
            font-weight: 100;
            margin-bottom: 2rem;
            text-align: center;
            animation: flicker 4s infinite;
            color: #C9BEFF;
            text-shadow: 0 0 15px #C9BEFF;
        }

        h2 {
            font-size: 1.5rem;
            letter-spacing: 3px;
            margin-bottom: 1.5rem;
            color: #C9BEFF;
        }

        /* Auth forms */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 2rem;
        }

        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid #C9BEFF;
        }

        .auth-tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            opacity: 0.6;
            transition: 0.3s;
            color: #C9BEFF;
            text-transform: uppercase;
        }

        .auth-tab:hover, .auth-tab.active {
            opacity: 1;
            border-bottom: 2px solid #C9BEFF;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.8rem;
            background-color: #262626;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 0.8rem;
            background-color: transparent;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:hover {
            background-color: #C9BEFF;
            color: #262626;
        }

        .message {
            margin-top: 1rem;
            padding: 0.8rem;
            display: none;
            text-align: center;
            border: 2px solid;
            animation: pulse 1.5s infinite;
        }

        .message.error {
            background-color: #2a0000;
            border-color: #8B0000;
            color: #FF8C8C;
        }

        .message.success {
            background-color: #002a00;
            border-color: #00FF00;
            color: #90EE90;
        }

        /* Feed */
        .feed {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .post {
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 1.5rem;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            color: #C9BEFF;
        }

        .post-author {
            font-weight: bold;
            cursor: pointer;
            text-decoration: underline;
        }

        .post-author:hover {
            text-shadow: 0 0 8px #C9BEFF;
        }

        .post-time {
            opacity: 0.5;
            font-size: 0.8rem;
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .post-media {
            max-width: 100%;
            margin-bottom: 1rem;
        }

        .post-media img, .post-media video {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 0 auto;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            border-top: 1px dashed #C9BEFF;
            padding-top: 1rem;
        }

        .like-btn, .comment-btn {
            background: none;
            border: none;
            color: #C9BEFF;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            opacity: 0.8;
            transition: 0.3s;
        }

        .like-btn:hover, .comment-btn:hover {
            opacity: 1;
            text-shadow: 0 0 8px #C9BEFF;
        }

        .like-count {
            font-size: 0.9rem;
        }

        /* Profile */
        .profile-header {
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-stats {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            opacity: 0.7;
            font-size: 0.8rem;
        }

        .follow-btn {
            background: none;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            padding: 0.5rem 1.5rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .follow-btn:hover {
            background-color: #C9BEFF;
            color: #262626;
        }

        .new-post {
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .new-post textarea {
            width: 100%;
            padding: 1rem;
            background-color: #262626;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 1rem;
        }

        .new-post input[type="file"] {
            margin-bottom: 1rem;
        }

        .post-type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .post-type {
            padding: 0.5rem 1rem;
            border: 1px solid #C9BEFF;
            cursor: pointer;
            opacity: 0.6;
        }

        .post-type.active {
            opacity: 1;
            background-color: #C9BEFF;
            color: #262626;
        }

        /* Chat */
        .chat-container {
            display: flex;
            gap: 2rem;
            height: 70vh;
        }

        .user-list {
            width: 250px;
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            overflow-y: auto;
        }

        .user-item {
            padding: 1rem;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: 0.3s;
        }

        .user-item:hover {
            background-color: #333;
            text-shadow: 0 0 5px #C9BEFF;
        }

        .user-item.selected {
            background-color: #C9BEFF;
            color: #262626;
        }

        .chat-area {
            flex: 1;
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #C9BEFF;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-item {
            max-width: 70%;
            padding: 0.8rem;
            border: 1px solid #C9BEFF;
        }

        .message-item.sent {
            align-self: flex-end;
            background-color: #333;
        }

        .message-item.received {
            align-self: flex-start;
            background-color: #1a1a1a;
        }

        .message-sender {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 0.3rem;
        }

        .chat-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #C9BEFF;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.8rem;
            background-color: #262626;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
        }

        .chat-input-area button {
            padding: 0.8rem 1.5rem;
            background: none;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .chat-input-area button:hover {
            background-color: #C9BEFF;
            color: #262626;
        }

        /* Upload page */
        .upload-container {
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 2rem;
        }

        .upload-area {
            border: 2px dashed #C9BEFF;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .upload-area:hover {
            background-color: #333;
        }

        .media-list {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .media-item {
            background-color: #262626;
            border: 1px solid #C9BEFF;
            padding: 0.8rem;
        }

        .media-thumbnail {
            height: 150px;
            background-color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        /* Footer */
        .footer {
            background-color: #1a1a1a;
            border-top: 1px solid #C9BEFF;
            padding: 1.5rem;
            text-align: center;
            margin-top: 3rem;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
            }
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            .user-list {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">NIGHTMARE</div>
        <div class="nav-links" id="navLinks">
            <a class="active" onclick="showPage('home')">ACCUEIL</a>
            <a onclick="showPage('profile')">PROFIL</a>
            <a onclick="showPage('chat')">CHAT</a>
            <a onclick="showPage('upload')">UPLOAD</a>
            <a onclick="showPage('rules')">R√àGLES</a>
        </div>
        <div class="user-info" id="userInfo" style="display: none;">
            <span id="currentUserName"></span>
            <button class="logout-btn" onclick="logout()">QUITTER</button>
        </div>
    </nav>

    <div class="container">
        <!-- Page d'authentification (visible si non connect√©) -->
        <div id="page-auth" class="page active">
            <h1>L'ANTRE DES √ÇMES PERDUES</h1>
            <div class="auth-container">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="switchAuthTab('signin')">D√âJ√Ä DES OMBRES</div>
                    <div class="auth-tab" onclick="switchAuthTab('signup')">PREMI√àRE VISITE</div>
                </div>
                <div id="signin-form" class="auth-form active">
                    <form onsubmit="return handleSignin(event)">
                        <div class="form-group">
                            <label>EMAIL</label>
                            <input type="email" id="signin-email" required>
                        </div>
                        <div class="form-group">
                            <label>CODE SP√âCIAL</label>
                            <input type="text" id="signin-code" required maxlength="8">
                        </div>
                        <button type="submit" class="btn">SE CONNECTER</button>
                    </form>
                    <div class="message error" id="signin-error"></div>
                </div>
                <div id="signup-form" class="auth-form">
                    <form onsubmit="return handleSignup(event)">
                        <div class="form-group">
                            <label>NOM</label>
                            <input type="text" id="signup-nom" required>
                        </div>
                        <div class="form-group">
                            <label>EMAIL</label>
                            <input type="email" id="signup-email" required>
                        </div>
                        <div class="form-group">
                            <label>MOT DE PASSE (min 6)</label>
                            <input type="password" id="signup-password" required minlength="6">
                        </div>
                        <button type="submit" class="btn">S'INSCRIRE</button>
                    </form>
                    <div class="message error" id="signup-error"></div>
                    <div class="message success" id="signup-success"></div>
                </div>
            </div>
        </div>

        <!-- Page Accueil (feed) -->
        <div id="page-home" class="page">
            <h1>FIL DES √ÇMES</h1>
            <div class="feed" id="feed"></div>
        </div>

        <!-- Page Profil -->
        <div id="page-profile" class="page">
            <div id="profile-view"></div>
        </div>

        <!-- Page Chat -->
        <div id="page-chat" class="page">
            <h1>CHAT DES OMBRES</h1>
            <div class="chat-container">
                <div class="user-list" id="userList"></div>
                <div class="chat-area" id="chatArea">
                    <div class="chat-header" id="chatHeader">S√©lectionnez une ombre</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area" id="chatInputArea" style="display: none;">
                        <input type="text" id="chatMessageInput" placeholder="Votre message...">
                        <button onclick="sendMessage()">ENVOYER</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Upload (m√©dias) -->
        <div id="page-upload" class="page">
            <h1>UPLOADER</h1>
            <div class="upload-container">
                <div class="upload-area" id="uploadArea" onclick="triggerFileInput()">
                    <div style="font-size: 2rem;">‚¨ÜÔ∏è</div>
                    <div>CLIQUEZ POUR UPLOADER UN FICHIER</div>
                    <div class="upload-info">Images, Vid√©os - MAX 50MB</div>
                </div>
                <input type="file" id="fileInput" accept="image/*,video/*" style="display: none;" onchange="handleFileUpload(this)">
                <div class="media-list" id="mediaList"></div>
            </div>
        </div>

        <!-- Page R√®gles -->
        <div id="page-rules" class="page">
            <h1>R√àGLES DE L'ANTRE</h1>
            <div class="rules-container" style="background:#1a1a1a; border:1px solid #C9BEFF; padding:2rem;">
                <!-- Les r√®gles ici (identique √† avant) -->
                <div class="rule-item">
                    <div class="rule-number">R√àGLE I</div>
                    <div class="rule-title">LE SILENCE EST OBLIGATOIRE</div>
                    <div class="rule-description">Aucun bruit ne doit √™tre √©mis entre minuit et 3 heures du matin. Les ombres se nourrissent des sons.</div>
                    <div class="punishment">SANCTION : Vous entendrez des chuchotements pendant 7 nuits.</div>
                </div>
                <!-- ... autres r√®gles ... -->
            </div>
        </div>
    </div>

    <!-- Message de terreur -->
    <div class="terror-message" id="terrorMessage" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#1a1a1a; border:3px solid #8B0000; padding:2rem; z-index:2000; display:none; text-align:center;">
        <div class="terror-title" style="color:#8B0000; font-size:2rem; margin-bottom:1rem;">TERREUR</div>
        <div class="terror-content" id="terrorContent" style="color:#FFB6C1; margin-bottom:1rem;"></div>
        <button class="terror-close" onclick="closeTerror()" style="background:none; border:2px solid #8B0000; color:#8B0000; padding:0.5rem 1rem; cursor:pointer;">ACCEPTER</button>
    </div>

    <footer class="footer">
        <p>ENTR√âE INTERDITE AUX √ÇMES SANS INVITATION</p>
    </footer>

    <script>
        // Configuration EmailJS
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: "Jr93TdCFENiLdSoTW",
            SERVICE_ID: "service_c4r0ejl",
            TEMPLATE_ID: "template_h4217se"
        };

        // Donn√©es
        let users = JSON.parse(localStorage.getItem('nightmare_users')) || [];
        let posts = JSON.parse(localStorage.getItem('nightmare_posts')) || [];
        let follows = JSON.parse(localStorage.getItem('nightmare_follows')) || [];
        let messages = JSON.parse(localStorage.getItem('nightmare_messages')) || [];
        let currentUser = JSON.parse(localStorage.getItem('nightmare_current_user')) || null;

        // Variables pour chat
        let selectedChatUser = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUser) {
                showMainApp();
            } else {
                document.getElementById('page-auth').classList.add('active');
            }
            updateUI();
        });

        // Fonctions d'authentification
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            if (tab === 'signin') {
                document.querySelector('.auth-tab').classList.add('active');
                document.getElementById('signin-form').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('signup-form').classList.add('active');
            }
        }

        function showTerror(msg) {
            document.getElementById('terrorContent').innerHTML = msg;
            document.getElementById('terrorMessage').style.display = 'block';
            setTimeout(() => document.getElementById('terrorMessage').style.display = 'none', 3000);
        }

        function closeTerror() {
            document.getElementById('terrorMessage').style.display = 'none';
        }

        function generateCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        function randomFunction() {
            const f = [
                { titre: "VEILLEUR NOCTURNE", description: "Vous surveillez les ombres." },
                { titre: "ARCHIVISTE", description: "Vous gardez la m√©moire." },
                { titre: "GARDIEN", description: "Vous prot√©gez les secrets." },
                { titre: "CHASSEUR", description: "Vous traquez les cauchemars." },
                { titre: "√âCHO", description: "Votre voix porte les avertissements." }
            ];
            return f[Math.floor(Math.random() * f.length)];
        }

        function emailExists(email) {
            return users.some(u => u.email === email);
        }

        function handleSignup(e) {
            e.preventDefault();
            const nom = document.getElementById('signup-nom').value;
            const email = document.getElementById('signup-email').value;
            const pwd = document.getElementById('signup-password').value;
            const error = document.getElementById('signup-error');
            const success = document.getElementById('signup-success');
            error.style.display = 'none';
            success.style.display = 'none';

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                error.textContent = 'EMAIL INVALIDE - L\'OMBRE REFUSE';
                error.style.display = 'block';
                showTerror('EMAIL INVALIDE');
                return false;
            }
            if (emailExists(email)) {
                error.textContent = 'EMAIL D√âJ√Ä PRIS PAR UNE AUTRE OMBRE';
                error.style.display = 'block';
                showTerror('EMAIL D√âJ√Ä UTILIS√â');
                return false;
            }
            if (pwd.length < 6) {
                error.textContent = 'MOT DE PASSE TROP FAIBLE';
                error.style.display = 'block';
                showTerror('MDP TROP COURT');
                return false;
            }

            const code = generateCode();
            const func = randomFunction();
            const newUser = { id: Date.now(), nom, email, password: pwd, code, function: func, avatar: null };
            users.push(newUser);
            localStorage.setItem('nightmare_users', JSON.stringify(users));

            // Envoyer email (simul√©)
            emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
            emailjs.send(EMAILJS_CONFIG.SERVICE_ID, EMAILJS_CONFIG.TEMPLATE_ID, {
                user_name: nom,
                user_email: email,
                special_code: code,
                user_function: func.titre,
                function_description: func.description,
                to_email: email
            }).catch(console.log);

            success.innerHTML = 'INSCRIPTION R√âUSSIE<br>VOTRE CODE : ' + code;
            success.style.display = 'block';
            document.getElementById('signupForm').reset();
            setTimeout(() => switchAuthTab('signin'), 2000);
            return false;
        }

        function handleSignin(e) {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const code = document.getElementById('signin-code').value.toUpperCase();
            const error = document.getElementById('signin-error');
            error.style.display = 'none';

            const user = users.find(u => u.email === email && u.code === code);
            if (!user) {
                error.textContent = 'ACC√àS REFUS√â - EMAIL OU CODE INVALIDE';
                error.style.display = 'block';
                showTerror('ACC√àS REFUS√â');
                return false;
            }

            currentUser = user;
            localStorage.setItem('nightmare_current_user', JSON.stringify(user));
            showMainApp();
            return false;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('nightmare_current_user');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-auth').classList.add('active');
            document.getElementById('userInfo').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('page-auth').classList.remove('active');
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('currentUserName').textContent = currentUser.nom;
            showPage('home');
        }

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-links a[onclick="showPage('${pageName}')"]`).classList.add('active');

            if (pageName === 'home') loadFeed();
            if (pageName === 'profile') loadProfile(currentUser.id);
            if (pageName === 'chat') loadChat();
            if (pageName === 'upload') loadMedia();
        }

        // Feed
        function loadFeed() {
            const feedDiv = document.getElementById('feed');
            feedDiv.innerHTML = '';
            // Tous les posts tri√©s par date
            const allPosts = [...posts].sort((a,b) => b.timestamp - a.timestamp);
            allPosts.forEach(post => {
                const author = users.find(u => u.id === post.userId) || { nom: 'Inconnu' };
                feedDiv.appendChild(createPostElement(post, author));
            });
        }

        function createPostElement(post, author) {
            const div = document.createElement('div');
            div.className = 'post';
            div.innerHTML = `
                <div class="post-header">
                    <span class="post-author" onclick="loadProfile(${post.userId})">${author.nom}</span>
                    <span class="post-time">${new Date(post.timestamp).toLocaleString()}</span>
                </div>
                <div class="post-content">${post.content || ''}</div>
                ${post.mediaUrl ? (post.mediaType === 'image' ? `<div class="post-media"><img src="${post.mediaUrl}" alt="media"></div>` : `<div class="post-media"><video src="${post.mediaUrl}" controls></video></div>`) : ''}
                <div class="post-actions">
                    <button class="like-btn" onclick="likePost(${post.id})">
                        <span>‚ù§Ô∏è</span> <span class="like-count">${post.likes ? post.likes.length : 0}</span>
                    </button>
                    <button class="comment-btn" onclick="alert('Fonction √† venir')">üí¨ Commenter</button>
                </div>
            `;
            return div;
        }

        function likePost(postId) {
            if (!currentUser) return;
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const index = post.likes.indexOf(currentUser.id);
            if (index === -1) post.likes.push(currentUser.id);
            else post.likes.splice(index, 1);
            localStorage.setItem('nightmare_posts', JSON.stringify(posts));
            loadFeed(); // recharger
        }

        // Profil
        function loadProfile(userId) {
            const profileDiv = document.getElementById('profile-view');
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const userPosts = posts.filter(p => p.userId === userId).sort((a,b) => b.timestamp - a.timestamp);
            const followers = follows.filter(f => f.followedId === userId).length;
            const following = follows.filter(f => f.followerId === userId).length;
            const isFollowed = currentUser && follows.some(f => f.followerId === currentUser.id && f.followedId === userId);

            let html = `
                <div class="profile-header">
                    <div>
                        <h2>${user.nom}</h2>
                        <p>${user.function.titre} - ${user.function.description}</p>
                    </div>
                    <div class="profile-stats">
                        <div class="stat"><span class="stat-number">${followers}</span><span class="stat-label">followers</span></div>
                        <div class="stat"><span class="stat-number">${following}</span><span class="stat-label">suivis</span></div>
                    </div>
                    ${currentUser && currentUser.id !== userId ? `<button class="follow-btn" onclick="toggleFollow(${userId})">${isFollowed ? 'NE PLUS SUIVRE' : 'SUIVRE'}</button>` : ''}
                </div>
            `;

            // Formulaire de nouveau post (seulement si c'est le profil de l'utilisateur connect√©)
            if (currentUser && currentUser.id === userId) {
                html += `
                    <div class="new-post">
                        <h3>PUBLIER UNE NOUVELLE OMBRE</h3>
                        <div class="post-type-selector">
                            <span class="post-type active" onclick="setPostType('text')">TEXTE</span>
                            <span class="post-type" onclick="setPostType('image')">IMAGE</span>
                            <span class="post-type" onclick="setPostType('video')">VID√âO</span>
                        </div>
                        <textarea id="postContent" placeholder="Votre message..."></textarea>
                        <input type="file" id="postFile" accept="image/*,video/*" style="display:none;">
                        <button class="btn" onclick="publishPost()">PUBLIER</button>
                    </div>
                `;
            }

            html += `<div class="feed" id="profilePosts"></div>`;
            profileDiv.innerHTML = html;

            const postsDiv = document.getElementById('profilePosts');
            userPosts.forEach(p => {
                postsDiv.appendChild(createPostElement(p, user));
            });
        }

        let currentPostType = 'text';
        function setPostType(type) {
            currentPostType = type;
            document.querySelectorAll('.post-type').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('postFile').style.display = (type === 'text') ? 'none' : 'block';
        }

        function publishPost() {
            const content = document.getElementById('postContent').value;
            const fileInput = document.getElementById('postFile');
            let mediaUrl = null;
            let mediaType = null;

            if (currentPostType !== 'text' && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                mediaUrl = URL.createObjectURL(file);
                mediaType = file.type.startsWith('image') ? 'image' : 'video';
            }

            const newPost = {
                id: Date.now(),
                userId: currentUser.id,
                content: content,
                mediaUrl: mediaUrl,
                mediaType: mediaType,
                timestamp: Date.now(),
                likes: []
            };
            posts.push(newPost);
            localStorage.setItem('nightmare_posts', JSON.stringify(posts));
            loadProfile(currentUser.id);
        }

        function toggleFollow(userId) {
            const exists = follows.find(f => f.followerId === currentUser.id && f.followedId === userId);
            if (exists) {
                follows = follows.filter(f => !(f.followerId === currentUser.id && f.followedId === userId));
            } else {
                follows.push({ followerId: currentUser.id, followedId: userId });
            }
            localStorage.setItem('nightmare_follows', JSON.stringify(follows));
            loadProfile(userId);
        }

        // Chat
        function loadChat() {
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = '';
            const otherUsers = users.filter(u => u.id !== currentUser.id);
            otherUsers.forEach(u => {
                const div = document.createElement('div');
                div.className = `user-item ${selectedChatUser === u.id ? 'selected' : ''}`;
                div.textContent = u.nom;
                div.onclick = () => selectChatUser(u.id);
                userListDiv.appendChild(div);
            });

            if (selectedChatUser) {
                displayChatMessages(selectedChatUser);
            } else {
                document.getElementById('chatHeader').textContent = 'S√©lectionnez une ombre';
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('chatInputArea').style.display = 'none';
            }
        }

        function selectChatUser(userId) {
            selectedChatUser = userId;
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            displayChatMessages(userId);
        }

        function displayChatMessages(userId) {
            const user = users.find(u => u.id === userId);
            document.getElementById('chatHeader').textContent = `Chat avec ${user.nom}`;
            const chatMessagesDiv = document.getElementById('chatMessages');
            chatMessagesDiv.innerHTML = '';
            const conv = messages.filter(m => 
                (m.from === currentUser.id && m.to === userId) ||
                (m.from === userId && m.to === currentUser.id)
            ).sort((a,b) => a.timestamp - b.timestamp);

            conv.forEach(m => {
                const div = document.createElement('div');
                div.className = `message-item ${m.from === currentUser.id ? 'sent' : 'received'}`;
                div.innerHTML = `<div class="message-sender">${m.from === currentUser.id ? 'Vous' : user.nom}</div><div>${m.text}</div>`;
                chatMessagesDiv.appendChild(div);
            });
            document.getElementById('chatInputArea').style.display = 'flex';
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatMessageInput');
            const text = input.value.trim();
            if (!text || !selectedChatUser) return;
            const msg = {
                from: currentUser.id,
                to: selectedChatUser,
                text: text,
                timestamp: Date.now()
            };
            messages.push(msg);
            localStorage.setItem('nightmare_messages', JSON.stringify(messages));
            input.value = '';
            displayChatMessages(selectedChatUser);
        }

        // Upload de m√©dias (pour la page upload)
        let mediaItems = JSON.parse(localStorage.getItem('nightmare_media')) || [];

        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }

        function handleFileUpload(input) {
            const files = input.files;
            for (let f of files) {
                if (f.size > 50 * 1024 * 1024) {
                    showTerror('FICHIER TROP LOURD (MAX 50MB)');
                    continue;
                }
                const url = URL.createObjectURL(f);
                const type = f.type.startsWith('image') ? 'image' : 'video';
                const media = {
                    id: Date.now() + Math.random(),
                    userId: currentUser.id,
                    name: f.name,
                    url: url,
                    type: type,
                    timestamp: Date.now()
                };
                mediaItems.push(media);
                localStorage.setItem('nightmare_media', JSON.stringify(mediaItems));
            }
            loadMedia();
        }

        function loadMedia() {
            const list = document.getElementById('mediaList');
            list.innerHTML = '';
            const userMedia = mediaItems.filter(m => m.userId === currentUser.id);
            userMedia.forEach(m => {
                const div = document.createElement('div');
                div.className = 'media-item';
                div.innerHTML = `
                    <div class="media-thumbnail">
                        ${m.type === 'image' ? `<img src="${m.url}" style="max-width:100%; max-height:150px;">` : `<video src="${m.url}" style="max-width:100%; max-height:150px;"></video>`}
                    </div>
                    <div>${m.name}</div>
                `;
                list.appendChild(div);
            });
        }

        // Raccourci pour les r√®gles (d√©j√† pr√©sentes)
        // On peut recopier les r√®gles ici
    </script>
</body>
</html>