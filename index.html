<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIGHTMARE WEB - L'Antre des √Çmes</title>
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        @keyframes flicker {
            0% { opacity: 1; text-shadow: none; }
            5% { opacity: 0.3; text-shadow: 0 0 15px #C9BEFF; }
            10% { opacity: 1; text-shadow: none; }
            15% { opacity: 0.2; text-shadow: 0 0 20px #C9BEFF; }
            20% { opacity: 1; text-shadow: none; }
            25% { opacity: 0.4; text-shadow: 0 0 10px #C9BEFF; }
            30% { opacity: 1; text-shadow: none; }
            100% { opacity: 1; text-shadow: none; }
        }

        @keyframes static {
            0% { transform: translate(0, 0); filter: brightness(1); }
            10% { transform: translate(-3px, 3px); filter: brightness(1.2); }
            20% { transform: translate(3px, -2px); filter: brightness(0.8); }
            30% { transform: translate(-2px, 1px); filter: brightness(1.1); }
            40% { transform: translate(2px, -1px); filter: brightness(0.9); }
            50% { transform: translate(0, 0); filter: brightness(1); }
            100% { transform: translate(0, 0); filter: brightness(1); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px #8B0000; }
            50% { box-shadow: 0 0 30px #FF4500; }
            100% { box-shadow: 0 0 10px #8B0000; }
        }

        body {
            background-color: #262626;
            color: #C9BEFF;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(201, 190, 255, 0.03) 0px,
                transparent 2px,
                rgba(201, 190, 255, 0.03) 4px
            );
            pointer-events: none;
            z-index: 1;
            animation: static 12s infinite;
        }

        body.rtl {
            direction: rtl;
            text-align: right;
        }

        .navbar {
            background-color: #1a1a1a;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #C9BEFF;
            position: relative;
            z-index: 10;
            flex-wrap: wrap;
        }

        .logo {
            color: #C9BEFF;
            font-size: 1.5rem;
            text-decoration: none;
            letter-spacing: 5px;
            animation: flicker 5s infinite;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #C9BEFF;
            text-decoration: none;
            font-size: 0.9rem;
            letter-spacing: 2px;
            opacity: 0.7;
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover {
            opacity: 1;
            text-shadow: 0 0 10px #C9BEFF;
        }

        .nav-links a.active {
            opacity: 1;
            border-bottom: 1px solid #C9BEFF;
        }

        .user-info {
            color: #C9BEFF;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: none;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            padding: 0.3rem 0.8rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .logout-btn:hover {
            background-color: #C9BEFF;
            color: #262626;
        }

        .lang-selector {
            display: flex;
            gap: 0.5rem;
            margin-right: 1rem;
        }

        .lang-selector button {
            background: none;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.8rem;
        }

        .lang-selector button:hover,
        .lang-selector button.active {
            background-color: #C9BEFF;
            color: #262626;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 5;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h1 {
            font-size: 2rem;
            letter-spacing: 5px;
            font-weight: 100;
            margin-bottom: 2rem;
            text-align: center;
            animation: flicker 4s infinite;
            color: #C9BEFF;
            text-shadow: 0 0 15px #C9BEFF;
        }

        h2 {
            font-size: 1.5rem;
            letter-spacing: 3px;
            margin-bottom: 1.5rem;
            color: #C9BEFF;
        }

        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 2rem;
        }

        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid #C9BEFF;
        }

        .auth-tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            opacity: 0.6;
            transition: 0.3s;
            color: #C9BEFF;
            text-transform: uppercase;
        }

        .auth-tab:hover, .auth-tab.active {
            opacity: 1;
            border-bottom: 2px solid #C9BEFF;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.8rem;
            background-color: #262626;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 0.8rem;
            background-color: transparent;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:hover {
            background-color: #C9BEFF;
            color: #262626;
        }

        .message {
            margin-top: 1rem;
            padding: 0.8rem;
            display: none;
            text-align: center;
            border: 2px solid;
            animation: pulse 1.5s infinite;
        }

        .message.error {
            background-color: #2a0000;
            border-color: #8B0000;
            color: #FF8C8C;
        }

        .message.success {
            background-color: #002a00;
            border-color: #00FF00;
            color: #90EE90;
        }

        .feed {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .post {
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 1.5rem;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            color: #C9BEFF;
        }

        .post-author {
            font-weight: bold;
            cursor: pointer;
            text-decoration: underline;
        }

        .post-author:hover {
            text-shadow: 0 0 8px #C9BEFF;
        }

        .post-time {
            opacity: 0.5;
            font-size: 0.8rem;
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .post-media {
            max-width: 100%;
            margin-bottom: 1rem;
        }

        .post-media img, .post-media video {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 0 auto;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            border-top: 1px dashed #C9BEFF;
            padding-top: 1rem;
        }

        .like-btn, .comment-btn {
            background: none;
            border: none;
            color: #C9BEFF;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            opacity: 0.8;
            transition: 0.3s;
        }

        .like-btn:hover, .comment-btn:hover {
            opacity: 1;
            text-shadow: 0 0 8px #C9BEFF;
        }

        .like-count {
            font-size: 0.9rem;
        }

        .profile-header {
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .profile-stats {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            opacity: 0.7;
            font-size: 0.8rem;
        }

        .follow-btn {
            background: none;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            padding: 0.5rem 1.5rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .follow-btn:hover {
            background-color: #C9BEFF;
            color: #262626;
        }

        .new-post {
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .new-post textarea {
            width: 100%;
            padding: 1rem;
            background-color: #262626;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 1rem;
        }

        .new-post input[type="file"] {
            margin-bottom: 1rem;
        }

        .post-type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .post-type {
            padding: 0.5rem 1rem;
            border: 1px solid #C9BEFF;
            cursor: pointer;
            opacity: 0.6;
        }

        .post-type.active {
            opacity: 1;
            background-color: #C9BEFF;
            color: #262626;
        }

        .chat-container {
            display: flex;
            gap: 2rem;
            height: 70vh;
        }

        .user-list {
            width: 250px;
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            overflow-y: auto;
        }

        .user-item {
            padding: 1rem;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: 0.3s;
        }

        .user-item:hover {
            background-color: #333;
            text-shadow: 0 0 5px #C9BEFF;
        }

        .user-item.selected {
            background-color: #C9BEFF;
            color: #262626;
        }

        .chat-area {
            flex: 1;
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #C9BEFF;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-item {
            max-width: 70%;
            padding: 0.8rem;
            border: 1px solid #C9BEFF;
        }

        .message-item.sent {
            align-self: flex-end;
            background-color: #333;
        }

        .message-item.received {
            align-self: flex-start;
            background-color: #1a1a1a;
        }

        .message-sender {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 0.3rem;
        }

        .chat-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #C9BEFF;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.8rem;
            background-color: #262626;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
        }

        .chat-input-area button {
            padding: 0.8rem 1.5rem;
            background: none;
            border: 1px solid #C9BEFF;
            color: #C9BEFF;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .chat-input-area button:hover {
            background-color: #C9BEFF;
            color: #262626;
        }

        .upload-container {
            background-color: #1a1a1a;
            border: 1px solid #C9BEFF;
            padding: 2rem;
        }

        .upload-area {
            border: 2px dashed #C9BEFF;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .upload-area:hover {
            background-color: #333;
        }

        .media-list {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .media-item {
            background-color: #262626;
            border: 1px solid #C9BEFF;
            padding: 0.8rem;
        }

        .media-thumbnail {
            height: 150px;
            background-color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        .footer {
            background-color: #1a1a1a;
            border-top: 1px solid #C9BEFF;
            padding: 1.5rem;
            text-align: center;
            margin-top: 3rem;
            opacity: 0.3;
        }

        .terror-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            border: 3px solid #8B0000;
            padding: 2rem;
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .terror-title {
            color: #8B0000;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .terror-content {
            color: #FFB6C1;
            margin-bottom: 1rem;
        }

        .terror-close {
            background: none;
            border: 2px solid #8B0000;
            color: #8B0000;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
            }
            .nav-links {
                justify-content: center;
            }
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            .user-list {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">NIGHTMARE</div>
        <div class="nav-links" id="navLinks">
            <a class="active" onclick="showPage('home')" data-i18n="nav_home">ACCUEIL</a>
            <a onclick="showPage('profile')" data-i18n="nav_profile">PROFIL</a>
            <a onclick="showPage('chat')" data-i18n="nav_chat">CHAT</a>
            <a onclick="showPage('upload')" data-i18n="nav_upload">UPLOAD</a>
            <a onclick="showPage('rules')" data-i18n="nav_rules">R√àGLES</a>
        </div>
        <div style="display: flex; align-items: center;">
            <div class="lang-selector">
                <button onclick="setLanguage('fr')" class="active">FR</button>
                <button onclick="setLanguage('en')">EN</button>
                <button onclick="setLanguage('ar')">AR</button>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="currentUserName"></span>
                <button class="logout-btn" onclick="logout()" data-i18n="logout">QUITTER</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="page-auth" class="page active">
            <h1 data-i18n="auth_title">L'ANTRE DES √ÇMES PERDUES</h1>
            <div class="auth-container">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="switchAuthTab('signin')" data-i18n="signin_tab">D√âJ√Ä DES OMBRES</div>
                    <div class="auth-tab" onclick="switchAuthTab('signup')" data-i18n="signup_tab">PREMI√àRE VISITE</div>
                </div>
                <div id="signin-form" class="auth-form active">
                    <form onsubmit="return handleSignin(event)">
                        <div class="form-group">
                            <label data-i18n="email">EMAIL</label>
                            <input type="email" id="signin-email" required>
                        </div>
                        <div class="form-group">
                            <label data-i18n="special_code">CODE SP√âCIAL</label>
                            <input type="text" id="signin-code" required maxlength="8">
                        </div>
                        <button type="submit" class="btn" data-i18n="signin_btn">SE CONNECTER</button>
                    </form>
                    <div class="message error" id="signin-error"></div>
                </div>
                <div id="signup-form" class="auth-form">
                    <form onsubmit="return handleSignup(event)">
                        <div class="form-group">
                            <label data-i18n="name">NOM</label>
                            <input type="text" id="signup-nom" required>
                        </div>
                        <div class="form-group">
                            <label data-i18n="email">EMAIL</label>
                            <input type="email" id="signup-email" required>
                        </div>
                        <div class="form-group">
                            <label data-i18n="password">MOT DE PASSE (min 6)</label>
                            <input type="password" id="signup-password" required minlength="6">
                        </div>
                        <button type="submit" class="btn" data-i18n="signup_btn">S'INSCRIRE</button>
                    </form>
                    <div class="message error" id="signup-error"></div>
                    <div class="message success" id="signup-success"></div>
                </div>
            </div>
        </div>

        <div id="page-home" class="page">
            <h1 data-i18n="feed_title">FIL DES √ÇMES</h1>
            <div class="feed" id="feed"></div>
        </div>

        <div id="page-profile" class="page">
            <div id="profile-view"></div>
        </div>

        <div id="page-chat" class="page">
            <h1 data-i18n="chat_title">CHAT DES OMBRES</h1>
            <div class="chat-container">
                <div class="user-list" id="userList"></div>
                <div class="chat-area" id="chatArea">
                    <div class="chat-header" id="chatHeader" data-i18n="chat_select">S√©lectionnez une ombre</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area" id="chatInputArea" style="display: none;">
                        <input type="text" id="chatMessageInput" placeholder="...">
                        <button onclick="sendMessage()" data-i18n="send">ENVOYER</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-upload" class="page">
            <h1 data-i18n="upload_title">UPLOADER</h1>
            <div class="upload-container">
                <div class="upload-area" id="uploadArea" onclick="triggerFileUpload()">
                    <div style="font-size: 2rem;">‚¨ÜÔ∏è</div>
                    <div data-i18n="upload_click">CLIQUEZ POUR UPLOADER UN FICHIER</div>
                    <div class="upload-info" data-i18n="upload_info">Images, Vid√©os - MAX 50MB</div>
                </div>
                <input type="file" id="fileUpload" accept="image/*,video/*" style="display: none;" onchange="handleFileUpload(this)">
            </div>
        </div>

        <div id="page-rules" class="page">
            <h1 data-i18n="rules_title">R√àGLES DE L'ANTRE</h1>
            <div class="rules-container" style="background:#1a1a1a; border:1px solid #C9BEFF; padding:2rem;">
                <div class="rule-item">
                    <div class="rule-number" data-i18n="rule1_num">R√àGLE I</div>
                    <div class="rule-title" data-i18n="rule1_title">LE SILENCE EST OBLIGATOIRE</div>
                    <div class="rule-description" data-i18n="rule1_desc">Aucun bruit ne doit √™tre √©mis entre minuit et 3 heures du matin. Les ombres se nourrissent des sons.</div>
                    <div class="punishment" data-i18n="rule1_punish">SANCTION : Vous entendrez des chuchotements pendant 7 nuits.</div>
                </div>
                <div class="rule-item">
                    <div class="rule-number" data-i18n="rule2_num">R√àGLE II</div>
                    <div class="rule-title" data-i18n="rule2_title">NE JAMAIS REGARDER DERRI√àRE SOI</div>
                    <div class="rule-description" data-i18n="rule2_desc">Si vous sentez une pr√©sence, ne vous retournez pas. Ce qui vous suit n'aime pas √™tre vu.</div>
                    <div class="punishment" data-i18n="rule2_punish">SANCTION : Vous verrez son visage dans vos r√™ves pour l'√©ternit√©.</div>
                </div>
                <div class="rule-item">
                    <div class="rule-number" data-i18n="rule3_num">R√àGLE III</div>
                    <div class="rule-title" data-i18n="rule3_title">LES MIROIRS SONT INTERDITS</div>
                    <div class="rule-description" data-i18n="rule3_desc">Tous les miroirs doivent √™tre couverts apr√®s le coucher du soleil. Votre reflet pourrait d√©cider de sortir.</div>
                    <div class="punishment" data-i18n="rule3_punish">SANCTION : Votre reflet vous remplacera pendant 24h.</div>
                </div>
                <div class="rule-item">
                    <div class="rule-number" data-i18n="rule4_num">R√àGLE IV</div>
                    <div class="rule-title" data-i18n="rule4_title">LES PORTES DOIVENT RESTER FERM√âES</div>
                    <div class="rule-description" data-i18n="rule4_desc">V√©rifiez chaque porte trois fois avant de dormir. Elles savent quand vous avez peur.</div>
                    <div class="punishment" data-i18n="rule4_punish">SANCTION : Une porte s'ouvrira dans votre sommeil.</div>
                </div>
                <div class="rule-item">
                    <div class="rule-number" data-i18n="rule5_num">R√àGLE V</div>
                    <div class="rule-title" data-i18n="rule5_title">R√âPONDRE AUX APPELS</div>
                    <div class="rule-description" data-i18n="rule5_desc">Si quelqu'un appelle votre nom la nuit et que vous √™tes seul, NE R√âPONDEZ PAS. Ce n'est jamais une nouvelle.</div>
                    <div class="punishment" data-i18n="rule5_punish">SANCTION : Vous entendrez ce nom chaque nuit jusqu'√† r√©pondre.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="terror-message" id="terrorMessage">
        <div class="terror-title" data-i18n="terror_title">TERREUR</div>
        <div class="terror-content" id="terrorContent"></div>
        <button class="terror-close" onclick="closeTerror()" data-i18n="terror_accept">ACCEPTER</button>
    </div>

    <footer class="footer">
        <p data-i18n="footer">ENTR√âE INTERDITE AUX √ÇMES SANS INVITATION</p>
    </footer>

    <script>
        // Configuration EmailJS
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: "Jr93TdCFENiLdSoTW",
            SERVICE_ID: "service_c4r0ejl",
            TEMPLATE_ID: "template_h4217se"
        };

        // Traductions
        const translations = {
            fr: {
                nav_home: "ACCUEIL",
                nav_profile: "PROFIL",
                nav_chat: "CHAT",
                nav_upload: "UPLOAD",
                nav_rules: "R√àGLES",
                logout: "QUITTER",
                auth_title: "L'ANTRE DES √ÇMES PERDUES",
                signin_tab: "D√âJ√Ä DES OMBRES",
                signup_tab: "PREMI√àRE VISITE",
                email: "EMAIL",
                special_code: "CODE SP√âCIAL",
                signin_btn: "SE CONNECTER",
                name: "NOM",
                password: "MOT DE PASSE (min 6)",
                signup_btn: "S'INSCRIRE",
                feed_title: "FIL DES √ÇMES",
                chat_title: "CHAT DES OMBRES",
                chat_select: "S√©lectionnez une ombre",
                send: "ENVOYER",
                upload_title: "UPLOADER",
                upload_click: "CLIQUEZ POUR UPLOADER UN FICHIER",
                upload_info: "Images, Vid√©os - MAX 50MB",
                rules_title: "R√àGLES DE L'ANTRE",
                rule1_num: "R√àGLE I",
                rule1_title: "LE SILENCE EST OBLIGATOIRE",
                rule1_desc: "Aucun bruit ne doit √™tre √©mis entre minuit et 3 heures du matin. Les ombres se nourrissent des sons.",
                rule1_punish: "SANCTION : Vous entendrez des chuchotements pendant 7 nuits.",
                rule2_num: "R√àGLE II",
                rule2_title: "NE JAMAIS REGARDER DERRI√àRE SOI",
                rule2_desc: "Si vous sentez une pr√©sence, ne vous retournez pas. Ce qui vous suit n'aime pas √™tre vu.",
                rule2_punish: "SANCTION : Vous verrez son visage dans vos r√™ves pour l'√©ternit√©.",
                rule3_num: "R√àGLE III",
                rule3_title: "LES MIROIRS SONT INTERDITS",
                rule3_desc: "Tous les miroirs doivent √™tre couverts apr√®s le coucher du soleil. Votre reflet pourrait d√©cider de sortir.",
                rule3_punish: "SANCTION : Votre reflet vous remplacera pendant 24h.",
                rule4_num: "R√àGLE IV",
                rule4_title: "LES PORTES DOIVENT RESTER FERM√âES",
                rule4_desc: "V√©rifiez chaque porte trois fois avant de dormir. Elles savent quand vous avez peur.",
                rule4_punish: "SANCTION : Une porte s'ouvrira dans votre sommeil.",
                rule5_num: "R√àGLE V",
                rule5_title: "R√âPONDRE AUX APPELS",
                rule5_desc: "Si quelqu'un appelle votre nom la nuit et que vous √™tes seul, NE R√âPONDEZ PAS. Ce n'est jamais une nouvelle.",
                rule5_punish: "SANCTION : Vous entendrez ce nom chaque nuit jusqu'√† r√©pondre.",
                terror_title: "TERREUR",
                terror_accept: "ACCEPTER",
                footer: "ENTR√âE INTERDITE AUX √ÇMES SANS INVITATION",
                err_email_invalid: "EMAIL INVALIDE - L'OMBRE REFUSE",
                err_email_taken: "EMAIL D√âJ√Ä PRIS PAR UNE AUTRE OMBRE",
                err_password_weak: "MOT DE PASSE TROP FAIBLE",
                err_auth_failed: "ACC√àS REFUS√â - EMAIL OU CODE INVALIDE",
                err_file_too_large: "FICHIER TROP LOURD (MAX 50MB)",
                err_video_only: "FORMAT VID√âO UNIQUEMENT",
                err_image_only: "FORMAT IMAGE UNIQUEMENT",
                success_signup: "INSCRIPTION R√âUSSIE",
                follow: "SUIVRE",
                unfollow: "NE PLUS SUIVRE",
                like: "J'AIME",
                comment: "COMMENTER",
                chat_with: "Chat avec",
                you: "Vous",
                text: "TEXTE",
                image: "IMAGE",
                video: "VID√âO",
                publish: "PUBLIER",
                new_post: "PUBLIER UNE NOUVELLE OMBRE",
                post_published: "Publication r√©ussie !",
                upload_success: "Fichier upload√© avec succ√®s"
            },
            en: {
                nav_home: "HOME",
                nav_profile: "PROFILE",
                nav_chat: "CHAT",
                nav_upload: "UPLOAD",
                nav_rules: "RULES",
                logout: "LEAVE",
                auth_title: "THE LAIR OF LOST SOULS",
                signin_tab: "ALREADY SHADOWS",
                signup_tab: "FIRST VISIT",
                email: "EMAIL",
                special_code: "SPECIAL CODE",
                signin_btn: "SIGN IN",
                name: "NAME",
                password: "PASSWORD (min 6)",
                signup_btn: "SIGN UP",
                feed_title: "SOULS FEED",
                chat_title: "SHADOWS CHAT",
                chat_select: "Select a shadow",
                send: "SEND",
                upload_title: "UPLOAD",
                upload_click: "CLICK TO UPLOAD A FILE",
                upload_info: "Images, Videos - MAX 50MB",
                rules_title: "LAIR RULES",
                rule1_num: "RULE I",
                rule1_title: "SILENCE IS MANDATORY",
                rule1_desc: "No noise between midnight and 3 AM. Shadows feed on sounds.",
                rule1_punish: "PUNISHMENT: You will hear whispers for 7 nights.",
                rule2_num: "RULE II",
                rule2_title: "NEVER LOOK BACK",
                rule2_desc: "If you feel a presence, don't turn around. What follows you doesn't like to be seen.",
                rule2_punish: "PUNISHMENT: You will see its face in your dreams forever.",
                rule3_num: "RULE III",
                rule3_title: "MIRRORS ARE FORBIDDEN",
                rule3_desc: "All mirrors must be covered after sunset. Your reflection might come out.",
                rule3_punish: "PUNISHMENT: Your reflection will replace you for 24h.",
                rule4_num: "RULE IV",
                rule4_title: "DOORS MUST STAY CLOSED",
                rule4_desc: "Check each door three times before sleeping. They know when you're afraid.",
                rule4_punish: "PUNISHMENT: A door will open in your sleep.",
                rule5_num: "RULE V",
                rule5_title: "ANSWERING CALLS",
                rule5_desc: "If someone calls your name at night and you're alone, DO NOT ANSWER. It's never good news.",
                rule5_punish: "PUNISHMENT: You will hear that name every night until you answer.",
                terror_title: "TERROR",
                terror_accept: "ACCEPT",
                footer: "ENTRY FORBIDDEN TO SOULS WITHOUT INVITATION",
                err_email_invalid: "INVALID EMAIL - SHADOW REFUSES",
                err_email_taken: "EMAIL ALREADY TAKEN BY ANOTHER SHADOW",
                err_password_weak: "PASSWORD TOO WEAK",
                err_auth_failed: "ACCESS DENIED - INVALID EMAIL OR CODE",
                err_file_too_large: "FILE TOO LARGE (MAX 50MB)",
                err_video_only: "VIDEO FORMAT ONLY",
                err_image_only: "IMAGE FORMAT ONLY",
                success_signup: "REGISTRATION SUCCESSFUL",
                follow: "FOLLOW",
                unfollow: "UNFOLLOW",
                like: "LIKE",
                comment: "COMMENT",
                chat_with: "Chat with",
                you: "You",
                text: "TEXT",
                image: "IMAGE",
                video: "VIDEO",
                publish: "PUBLISH",
                new_post: "PUBLISH A NEW SHADOW",
                post_published: "Post published successfully!",
                upload_success: "File uploaded successfully"
            },
            ar: {
                nav_home: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
                nav_profile: "ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä",
                nav_chat: "ÿßŸÑÿØÿ±ÿØÿ¥ÿ©",
                nav_upload: "ÿ±ŸÅÿπ",
                nav_rules: "ÿßŸÑŸÇŸàÿßÿπÿØ",
                logout: "ŸÖÿ∫ÿßÿØÿ±ÿ©",
                auth_title: "ŸàŸÉÿ± ÿßŸÑÿ£ÿ±Ÿàÿßÿ≠ ÿßŸÑŸÖŸÅŸÇŸàÿØÿ©",
                signin_tab: "ÿ∏ŸÑÿßŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ",
                signup_tab: "ÿ≤Ÿäÿßÿ±ÿ© ÿ£ŸàŸÑŸâ",
                email: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
                special_code: "ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑÿÆÿßÿµ",
                signin_btn: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                name: "ÿßŸÑÿßÿ≥ŸÖ",
                password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± (6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)",
                signup_btn: "ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ",
                feed_title: "ÿ™ÿ∫ÿ∞Ÿäÿ© ÿßŸÑÿ£ÿ±Ÿàÿßÿ≠",
                chat_title: "ÿØÿ±ÿØÿ¥ÿ© ÿßŸÑÿ∏ŸÑÿßŸÑ",
                chat_select: "ÿßÿÆÿ™ÿ± ÿ∏ŸÑÿßŸã",
                send: "ÿ•ÿ±ÿ≥ÿßŸÑ",
                upload_title: "ÿ±ŸÅÿπ",
                upload_click: "ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ",
                upload_info: "ÿµŸàÿ±ÿå ŸÅŸäÿØŸäŸàŸáÿßÿ™ - ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 50 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™",
                rules_title: "ŸÇŸàÿßÿπÿØ ÿßŸÑŸàŸÉÿ±",
                rule1_num: "ÿßŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ£ŸàŸÑŸâ",
                rule1_title: "ÿßŸÑÿµŸÖÿ™ ÿ•ŸÑÿ≤ÿßŸÖŸä",
                rule1_desc: "ŸÑÿß ÿ∂Ÿàÿ∂ÿßÿ° ÿ®ŸäŸÜ ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑŸäŸÑ ŸàÿßŸÑÿ´ÿßŸÑÿ´ÿ© ÿµÿ®ÿßÿ≠ÿßŸã. ÿßŸÑÿ∏ŸÑÿßŸÑ ÿ™ÿ™ÿ∫ÿ∞Ÿâ ÿπŸÑŸâ ÿßŸÑÿ£ÿµŸàÿßÿ™.",
                rule1_punish: "ÿßŸÑÿπŸÇŸàÿ®ÿ©: ÿ≥ÿ™ÿ≥ŸÖÿπ ŸáŸÖÿ≥ÿßÿ™ ŸÑŸÖÿØÿ© 7 ŸÑŸäÿßŸÑŸç.",
                rule2_num: "ÿßŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©",
                rule2_title: "ŸÑÿß ÿ™ŸÜÿ∏ÿ± ÿÆŸÑŸÅŸÉ ÿ£ÿ®ÿØÿßŸã",
                rule2_desc: "ÿ•ÿ∞ÿß ÿ¥ÿπÿ±ÿ™ ÿ®Ÿàÿ¨ŸàÿØÿå ŸÑÿß ÿ™ÿ≥ÿ™ÿØÿ±. ŸÖÿß Ÿäÿ™ÿ®ÿπŸÉ ŸÑÿß Ÿäÿ≠ÿ® ÿ£ŸÜ ŸäŸèÿ±Ÿâ.",
                rule2_punish: "ÿßŸÑÿπŸÇŸàÿ®ÿ©: ÿ≥ÿ™ÿ±Ÿâ Ÿàÿ¨ŸáŸá ŸÅŸä ÿ£ÿ≠ŸÑÿßŸÖŸÉ ÿ•ŸÑŸâ ÿßŸÑÿ£ÿ®ÿØ.",
                rule3_num: "ÿßŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©",
                rule3_title: "ÿßŸÑŸÖÿ±ÿßŸäÿß ŸÖŸÖŸÜŸàÿπÿ©",
                rule3_desc: "Ÿäÿ¨ÿ® ÿ™ÿ∫ÿ∑Ÿäÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ±ÿßŸäÿß ÿ®ÿπÿØ ÿ∫ÿ±Ÿàÿ® ÿßŸÑÿ¥ŸÖÿ≥. ŸÇÿØ ŸäÿÆÿ±ÿ¨ ÿßŸÜÿπŸÉÿßÿ≥ŸÉ.",
                rule3_punish: "ÿßŸÑÿπŸÇŸàÿ®ÿ©: ÿ≥Ÿäÿ≠ŸÑ ŸÖÿ≠ŸÑŸÉ ÿßŸÜÿπŸÉÿßÿ≥ŸÉ ŸÑŸÖÿØÿ© 24 ÿ≥ÿßÿπÿ©.",
                rule4_num: "ÿßŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ±ÿßÿ®ÿπÿ©",
                rule4_title: "Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿ®ŸÇŸâ ÿßŸÑÿ£ÿ®Ÿàÿßÿ® ŸÖÿ∫ŸÑŸÇÿ©",
                rule4_desc: "ÿßŸÅÿ≠ÿµ ŸÉŸÑ ÿ®ÿßÿ® ÿ´ŸÑÿßÿ´ ŸÖÿ±ÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑŸÜŸàŸÖ. ÿ•ŸÜŸáÿß ÿ™ÿπÿ±ŸÅ ŸÖÿ™Ÿâ ÿ™ÿÆÿßŸÅ.",
                rule4_punish: "ÿßŸÑÿπŸÇŸàÿ®ÿ©: ÿ≥ŸäŸÅÿ™ÿ≠ ÿ®ÿßÿ® ÿ£ÿ´ŸÜÿßÿ° ŸÜŸàŸÖŸÉ.",
                rule5_num: "ÿßŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿÆÿßŸÖÿ≥ÿ©",
                rule5_title: "ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑŸÖŸÉÿßŸÑŸÖÿßÿ™",
                rule5_desc: "ÿ•ÿ∞ÿß ŸÜÿßÿØŸâ ÿ£ÿ≠ÿØŸáŸÖ ÿßÿ≥ŸÖŸÉ ŸÑŸäŸÑÿßŸã ŸàŸÉŸÜÿ™ Ÿàÿ≠ÿØŸÉÿå ŸÑÿß ÿ™ÿ¨ÿ®. ÿ•ŸÜŸá ŸÑŸäÿ≥ ÿÆÿ®ÿ±ÿßŸã ÿ¨ŸäÿØÿßŸã ÿ£ÿ®ÿØÿßŸã.",
                rule5_punish: "ÿßŸÑÿπŸÇŸàÿ®ÿ©: ÿ≥ÿ™ÿ≥ŸÖÿπ Ÿáÿ∞ÿß ÿßŸÑÿßÿ≥ŸÖ ŸÉŸÑ ŸÑŸäŸÑÿ© ÿ≠ÿ™Ÿâ ÿ™ÿ¨Ÿäÿ®.",
                terror_title: "ÿ±ÿπÿ®",
                terror_accept: "ŸÇÿ®ŸàŸÑ",
                footer: "ÿßŸÑÿØÿÆŸàŸÑ ŸÖŸÖŸÜŸàÿπ ÿπŸÑŸâ ÿßŸÑÿ£ÿ±Ÿàÿßÿ≠ ÿ®ÿØŸàŸÜ ÿØÿπŸàÿ©",
                err_email_invalid: "ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ - ÿßŸÑÿ∏ŸÑ Ÿäÿ±ŸÅÿ∂",
                err_email_taken: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÖŸÜ ŸÇÿ®ŸÑ ÿ∏ŸÑ ÿ¢ÿÆÿ±",
                err_password_weak: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∂ÿπŸäŸÅÿ© ÿ¨ÿØÿßŸã",
                err_auth_failed: "ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑŸàÿµŸàŸÑ - ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ£Ÿà ÿ±ŸÖÿ≤ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠",
                err_file_too_large: "ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 50 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™)",
                err_video_only: "ÿ™ŸÜÿ≥ŸäŸÇ ŸÅŸäÿØŸäŸà ŸÅŸÇÿ∑",
                err_image_only: "ÿ™ŸÜÿ≥ŸäŸÇ ÿµŸàÿ±ÿ© ŸÅŸÇÿ∑",
                success_signup: "ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠",
                follow: "ŸÖÿ™ÿßÿ®ÿπÿ©",
                unfollow: "ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©",
                like: "ÿ•ÿπÿ¨ÿßÿ®",
                comment: "ÿ™ÿπŸÑŸäŸÇ",
                chat_with: "ÿØÿ±ÿØÿ¥ÿ© ŸÖÿπ",
                you: "ÿ£ŸÜÿ™",
                text: "ŸÜÿµ",
                image: "ÿµŸàÿ±ÿ©",
                video: "ŸÅŸäÿØŸäŸà",
                publish: "ŸÜÿ¥ÿ±",
                new_post: "ÿßŸÜÿ¥ÿ± ÿ∏ŸÑÿßŸã ÿ¨ÿØŸäÿØÿßŸã",
                post_published: "ÿ™ŸÖ ÿßŸÑŸÜÿ¥ÿ± ÿ®ŸÜÿ¨ÿßÿ≠!",
                upload_success: "ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠"
            }
        };

        let currentLanguage = 'fr';
        let users = JSON.parse(localStorage.getItem('nightmare_users')) || [];
        let posts = JSON.parse(localStorage.getItem('nightmare_posts')) || [];
        let follows = JSON.parse(localStorage.getItem('nightmare_follows')) || [];
        let messages = JSON.parse(localStorage.getItem('nightmare_messages')) || [];
        let currentUser = JSON.parse(localStorage.getItem('nightmare_current_user')) || null;
        let selectedChatUser = null;
        let currentPostType = 'text';

        document.addEventListener('DOMContentLoaded', () => {
            setLanguage('fr');
            if (currentUser) {
                showMainApp();
            } else {
                document.getElementById('page-auth').classList.add('active');
            }
        });

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-selector button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-selector button[onclick="setLanguage('${lang}')"]`).classList.add('active');
            
            if (lang === 'ar') {
                document.body.classList.add('rtl');
            } else {
                document.body.classList.remove('rtl');
            }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            if (selectedChatUser) {
                const user = users.find(u => u.id === selectedChatUser);
                if (user) {
                    document.getElementById('chatHeader').textContent = translations[lang].chat_with + ' ' + user.nom;
                }
            }

            if (document.getElementById('page-home').classList.contains('active')) {
                loadFeed();
            }
            if (document.getElementById('page-profile').classList.contains('active') && currentUser) {
                loadProfile(currentUser.id);
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            if (tab === 'signin') {
                document.querySelector('.auth-tab').classList.add('active');
                document.getElementById('signin-form').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('signup-form').classList.add('active');
            }
        }

        function showTerror(msg) {
            document.getElementById('terrorContent').innerHTML = msg;
            document.getElementById('terrorMessage').style.display = 'block';
            setTimeout(() => document.getElementById('terrorMessage').style.display = 'none', 3000);
        }

        function closeTerror() {
            document.getElementById('terrorMessage').style.display = 'none';
        }

        function generateCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        function randomFunction() {
            const f = [
                { titre: "VEILLEUR NOCTURNE", description: "Vous surveillez les ombres." },
                { titre: "ARCHIVISTE", description: "Vous gardez la m√©moire." },
                { titre: "GARDIEN", description: "Vous prot√©gez les secrets." },
                { titre: "CHASSEUR", description: "Vous traquez les cauchemars." },
                { titre: "√âCHO", description: "Votre voix porte les avertissements." }
            ];
            return f[Math.floor(Math.random() * f.length)];
        }

        function emailExists(email) {
            return users.some(u => u.email === email);
        }

        function handleSignup(e) {
            e.preventDefault();
            const nom = document.getElementById('signup-nom').value;
            const email = document.getElementById('signup-email').value;
            const pwd = document.getElementById('signup-password').value;
            const error = document.getElementById('signup-error');
            const success = document.getElementById('signup-success');
            error.style.display = 'none';
            success.style.display = 'none';

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                error.textContent = translations[currentLanguage].err_email_invalid;
                error.style.display = 'block';
                showTerror(translations[currentLanguage].err_email_invalid);
                return false;
            }
            if (emailExists(email)) {
                error.textContent = translations[currentLanguage].err_email_taken;
                error.style.display = 'block';
                showTerror(translations[currentLanguage].err_email_taken);
                return false;
            }
            if (pwd.length < 6) {
                error.textContent = translations[currentLanguage].err_password_weak;
                error.style.display = 'block';
                showTerror(translations[currentLanguage].err_password_weak);
                return false;
            }

            const code = generateCode();
            const func = randomFunction();
            const newUser = { id: Date.now(), nom, email, password: pwd, code, function: func, avatar: null };
            users.push(newUser);
            localStorage.setItem('nightmare_users', JSON.stringify(users));

            emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
            emailjs.send(EMAILJS_CONFIG.SERVICE_ID, EMAILJS_CONFIG.TEMPLATE_ID, {
                user_name: nom,
                user_email: email,
                special_code: code,
                user_function: func.titre,
                function_description: func.description,
                to_email: email
            }).catch(console.log);

            success.innerHTML = translations[currentLanguage].success_signup + '<br>' + translations[currentLanguage].special_code + ' : ' + code;
            success.style.display = 'block';
            document.getElementById('signupForm').reset();
            setTimeout(() => switchAuthTab('signin'), 2000);
            return false;
        }

        function handleSignin(e) {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const code = document.getElementById('signin-code').value.toUpperCase();
            const error = document.getElementById('signin-error');
            error.style.display = 'none';

            const user = users.find(u => u.email === email && u.code === code);
            if (!user) {
                error.textContent = translations[currentLanguage].err_auth_failed;
                error.style.display = 'block';
                showTerror(translations[currentLanguage].err_auth_failed);
                return false;
            }

            currentUser = user;
            localStorage.setItem('nightmare_current_user', JSON.stringify(user));
            showMainApp();
            return false;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('nightmare_current_user');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-auth').classList.add('active');
            document.getElementById('userInfo').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('page-auth').classList.remove('active');
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('currentUserName').textContent = currentUser.nom;
            showPage('home');
        }

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-links a[onclick="showPage('${pageName}')"]`).classList.add('active');

            if (pageName === 'home') loadFeed();
            if (pageName === 'profile') loadProfile(currentUser.id);
            if (pageName === 'chat') loadChat();
        }

        // FEED - Maintenant PUBLIC (tous les posts visibles)
        function loadFeed() {
            const feedDiv = document.getElementById('feed');
            feedDiv.innerHTML = '';
            
            // Trier tous les posts du plus r√©cent au plus ancien
            const allPosts = [...posts].sort((a, b) => b.timestamp - a.timestamp);
            
            if (allPosts.length === 0) {
                feedDiv.innerHTML = '<div style="text-align:center; padding:2rem; opacity:0.5;">Aucune publication pour le moment...</div>';
                return;
            }
            
            allPosts.forEach(post => {
                const author = users.find(u => u.id === post.userId) || { nom: '√Çme disparue', id: null };
                feedDiv.appendChild(createPostElement(post, author));
            });
        }

        function createPostElement(post, author) {
            const div = document.createElement('div');
            div.className = 'post';
            
            // V√©rifier si l'utilisateur actuel a lik√© ce post
            const isLiked = currentUser && post.likes && post.likes.includes(currentUser.id);
            const likeButtonText = isLiked ? '‚ù§Ô∏è' : 'ü§ç';
            
            div.innerHTML = `
                <div class="post-header">
                    <span class="post-author" onclick="loadProfile(${post.userId})">${author.nom}</span>
                    <span class="post-time">${new Date(post.timestamp).toLocaleString()}</span>
                </div>
                ${post.content ? `<div class="post-content">${post.content}</div>` : ''}
                ${post.mediaUrl ? (post.mediaType === 'image' ? 
                    `<div class="post-media"><img src="${post.mediaUrl}" alt="media" style="max-width:100%;"></div>` : 
                    `<div class="post-media"><video src="${post.mediaUrl}" controls style="max-width:100%;"></video></div>`) : ''}
                <div class="post-actions">
                    <button class="like-btn" onclick="likePost(${post.id})">
                        <span>${likeButtonText}</span> <span class="like-count">${post.likes ? post.likes.length : 0}</span>
                    </button>
                    <button class="comment-btn" onclick="alert('${translations[currentLanguage].comment}')">üí¨ ${translations[currentLanguage].comment}</button>
                </div>
            `;
            return div;
        }

        function likePost(postId) {
            if (!currentUser) return;
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            if (!post.likes) post.likes = [];
            
            const index = post.likes.indexOf(currentUser.id);
            if (index === -1) {
                post.likes.push(currentUser.id);
            } else {
                post.likes.splice(index, 1);
            }
            
            localStorage.setItem('nightmare_posts', JSON.stringify(posts));
            loadFeed(); // Recharger le feed
        }

        // PROFIL
        function loadProfile(userId) {
            const profileDiv = document.getElementById('profile-view');
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Posts de CET utilisateur uniquement (pour son profil)
            const userPosts = posts.filter(p => p.userId === userId).sort((a, b) => b.timestamp - a.timestamp);
            
            const followers = follows.filter(f => f.followedId === userId).length;
            const following = follows.filter(f => f.followerId === userId).length;
            const isFollowed = currentUser && follows.some(f => f.followerId === currentUser.id && f.followedId === userId);

            let html = `
                <div class="profile-header">
                    <div>
                        <h2>${user.nom}</h2>
                        <p>${user.function.titre} - ${user.function.description}</p>
                    </div>
                    <div class="profile-stats">
                        <div class="stat"><span class="stat-number">${followers}</span><span class="stat-label">${translations[currentLanguage].follow}</span></div>
                        <div class="stat"><span class="stat-number">${following}</span><span class="stat-label">${translations[currentLanguage].unfollow}</span></div>
                    </div>
                    ${currentUser && currentUser.id !== userId ? 
                        `<button class="follow-btn" onclick="toggleFollow(${userId})">${isFollowed ? translations[currentLanguage].unfollow : translations[currentLanguage].follow}</button>` : ''}
                </div>
            `;

            // Formulaire de publication (seulement si c'est le profil de l'utilisateur connect√©)
            if (currentUser && currentUser.id === userId) {
                html += `
                    <div class="new-post">
                        <h3>${translations[currentLanguage].new_post}</h3>
                        <div class="post-type-selector">
                            <span class="post-type active" onclick="setPostType('text')">${translations[currentLanguage].text}</span>
                            <span class="post-type" onclick="setPostType('image')">${translations[currentLanguage].image}</span>
                            <span class="post-type" onclick="setPostType('video')">${translations[currentLanguage].video}</span>
                        </div>
                        <textarea id="postContent" placeholder="..."></textarea>
                        <input type="file" id="postFile" accept="image/*,video/*" style="display: none;">
                        <button class="btn" onclick="publishPost()">${translations[currentLanguage].publish}</button>
                    </div>
                `;
            }

            html += `<h3 style="margin:2rem 0 1rem;">Publications</h3>`;
            html += `<div class="feed" id="profilePosts"></div>`;
            profileDiv.innerHTML = html;

            const postsDiv = document.getElementById('profilePosts');
            if (userPosts.length === 0) {
                postsDiv.innerHTML = '<div style="text-align:center; padding:2rem; opacity:0.5;">Aucune publication</div>';
            } else {
                userPosts.forEach(p => {
                    postsDiv.appendChild(createPostElement(p, user));
                });
            }
        }

        function setPostType(type) {
            currentPostType = type;
            document.querySelectorAll('.post-type').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('postFile').style.display = (type === 'text') ? 'none' : 'block';
        }

        function publishPost() {
            const content = document.getElementById('postContent').value;
            const fileInput = document.getElementById('postFile');
            let mediaUrl = null;
            let mediaType = null;

            if (currentPostType !== 'text' && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > 50 * 1024 * 1024) {
                    showTerror(translations[currentLanguage].err_file_too_large);
                    return;
                }
                
                // Cr√©er une URL pour le fichier (simul√© - en vrai il faudrait uploader sur un serveur)
                mediaUrl = URL.createObjectURL(file);
                mediaType = file.type.startsWith('image') ? 'image' : 'video';
            }

            const newPost = {
                id: Date.now() + Math.random(),
                userId: currentUser.id,
                content: content,
                mediaUrl: mediaUrl,
                mediaType: mediaType,
                timestamp: Date.now(),
                likes: []
            };
            
            posts.push(newPost);
            localStorage.setItem('nightmare_posts', JSON.stringify(posts));
            
            showTerror(translations[currentLanguage].post_published);
            
            // R√©initialiser le formulaire
            document.getElementById('postContent').value = '';
            if (fileInput) fileInput.value = '';
            
            // Recharger le profil
            loadProfile(currentUser.id);
        }

        function toggleFollow(userId) {
            const exists = follows.find(f => f.followerId === currentUser.id && f.followedId === userId);
            if (exists) {
                follows = follows.filter(f => !(f.followerId === currentUser.id && f.followedId === userId));
            } else {
                follows.push({ followerId: currentUser.id, followedId: userId });
            }
            localStorage.setItem('nightmare_follows', JSON.stringify(follows));
            loadProfile(userId);
        }

        // CHAT
        function loadChat() {
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = '';
            const otherUsers = users.filter(u => u.id !== currentUser.id);
            
            if (otherUsers.length === 0) {
                userListDiv.innerHTML = '<div style="padding:1rem; opacity:0.5;">Aucune autre ombre...</div>';
                return;
            }
            
            otherUsers.forEach(u => {
                const div = document.createElement('div');
                div.className = `user-item ${selectedChatUser === u.id ? 'selected' : ''}`;
                div.textContent = u.nom;
                div.onclick = () => selectChatUser(u.id);
                userListDiv.appendChild(div);
            });

            if (selectedChatUser) {
                displayChatMessages(selectedChatUser);
            } else {
                document.getElementById('chatHeader').textContent = translations[currentLanguage].chat_select;
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('chatInputArea').style.display = 'none';
            }
        }

        function selectChatUser(userId) {
            selectedChatUser = userId;
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            displayChatMessages(userId);
        }

        function displayChatMessages(userId) {
            const user = users.find(u => u.id === userId);
            document.getElementById('chatHeader').textContent = translations[currentLanguage].chat_with + ' ' + user.nom;
            const chatMessagesDiv = document.getElementById('chatMessages');
            chatMessagesDiv.innerHTML = '';
            
            const conv = messages.filter(m => 
                (m.from === currentUser.id && m.to === userId) ||
                (m.from === userId && m.to === currentUser.id)
            ).sort((a, b) => a.timestamp - b.timestamp);

            conv.forEach(m => {
                const div = document.createElement('div');
                div.className = `message-item ${m.from === currentUser.id ? 'sent' : 'received'}`;
                div.innerHTML = `<div class="message-sender">${m.from === currentUser.id ? translations[currentLanguage].you : user.nom}</div><div>${m.text}</div>`;
                chatMessagesDiv.appendChild(div);
            });
            
            document.getElementById('chatInputArea').style.display = 'flex';
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatMessageInput');
            const text = input.value.trim();
            if (!text || !selectedChatUser) return;
            
            const msg = {
                from: currentUser.id,
                to: selectedChatUser,
                text: text,
                timestamp: Date.now()
            };
            
            messages.push(msg);
            localStorage.setItem('nightmare_messages', JSON.stringify(messages));
            input.value = '';
            displayChatMessages(selectedChatUser);
        }

        // UPLOAD - Version simplifi√©e pour uploader des fichiers
        function triggerFileUpload() {
            document.getElementById('fileUpload').click();
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 50 * 1024 * 1024) {
                showTerror(translations[currentLanguage].err_file_too_large);
                return;
            }
            
            // Simuler l'upload (en vrai, il faudrait un serveur)
            showTerror(translations[currentLanguage].upload_success);
            
            // Optionnel : cr√©er automatiquement un post avec ce m√©dia
            if (confirm("Voulez-vous publier ce fichier dans votre fil ?")) {
                const mediaUrl = URL.createObjectURL(file);
                const mediaType = file.type.startsWith('image') ? 'image' : 'video';
                
                const newPost = {
                    id: Date.now() + Math.random(),
                    userId: currentUser.id,
                    content: "Nouveau m√©dia upload√©",
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                    timestamp: Date.now(),
                    likes: []
                };
                
                posts.push(newPost);
                localStorage.setItem('nightmare_posts', JSON.stringify(posts));
            }
            
            input.value = '';
        }
    </script>
</body>
</html>